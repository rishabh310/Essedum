name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: 'false'

env:
  APP_NAME: agent-dk
  PYTHON_VERSION: "3.11"
  DOCKER_IMAGE: agent-dk
  DOCKER_TAG: ${{ github.sha }}

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies locally (for testing)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run syntax checks
        run: |
          python -m py_compile src/*.py
          echo "âœ… Python syntax check passed"
      
      - name: Build Docker image
        run: |
          echo "ðŸ‹ Building Docker image..."
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} .
          docker tag ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} ${{ env.DOCKER_IMAGE }}:latest
          echo "âœ… Docker image built successfully"
      
      - name: Save Docker image to file
        run: |
          echo "ðŸ’¾ Saving Docker image to tar file..."
          docker save ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} | gzip > ${{ env.DOCKER_IMAGE }}-${{ env.DOCKER_TAG }}.tar.gz
          ls -lh ${{ env.DOCKER_IMAGE }}-${{ env.DOCKER_TAG }}.tar.gz
          echo "âœ… Docker image saved"
      
      - name: Copy Docker image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          source: "${{ env.DOCKER_IMAGE }}-${{ env.DOCKER_TAG }}.tar.gz"
          target: "/tmp/"
      
      - name: Load and Deploy Docker Container on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          script: |
            set -e
            
            echo "ðŸš€ Starting Docker deployment..."
            echo "User: $(whoami)"
            echo "Image: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "ðŸ‹ Installing Docker..."
              
              # Detect OS and install Docker
              if [ -f /etc/os-release ]; then
                . /etc/os-release
                if [[ "$ID" == "amzn" ]] || [[ "$ID_LIKE" == *"rhel"* ]]; then
                  # Amazon Linux 2 or RHEL-based
                  sudo yum update -y
                  sudo yum install -y docker
                  sudo systemctl start docker
                  sudo systemctl enable docker
                  sudo usermod -a -G docker $(whoami)
                elif [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]]; then
                  # Ubuntu or Debian
                  sudo apt-get update
                  sudo apt-get install -y docker.io
                  sudo systemctl start docker
                  sudo systemctl enable docker
                  sudo usermod -a -G docker $(whoami)
                fi
              fi
              
              echo "âœ… Docker installed"
              echo "âš ï¸ Note: You may need to log out and back in for group changes to take effect"
              
              # Try to use docker with sudo if needed
              if ! docker ps &> /dev/null; then
                echo "Using sudo for Docker commands..."
                DOCKER_CMD="sudo docker"
              else
                DOCKER_CMD="docker"
              fi
            else
              echo "âœ… Docker already installed"
              
              # Check if we can run docker without sudo
              if ! docker ps &> /dev/null; then
                DOCKER_CMD="sudo docker"
              else
                DOCKER_CMD="docker"
              fi
            fi
            
            # Load Docker image from tar file
            echo "ðŸ“¥ Loading Docker image from tar file..."
            $DOCKER_CMD load -i /tmp/${{ env.DOCKER_IMAGE }}-${{ env.DOCKER_TAG }}.tar.gz
            echo "âœ… Docker image loaded"
            
            # Stop and remove existing container if it exists
            echo "ðŸ›‘ Stopping existing container..."
            $DOCKER_CMD stop ${{ env.APP_NAME }} 2>/dev/null || true
            $DOCKER_CMD rm ${{ env.APP_NAME }} 2>/dev/null || true
            
            # Remove old images (keep last 3)
            echo "ðŸ§¹ Cleaning up old images..."
            $DOCKER_CMD images ${{ env.DOCKER_IMAGE }} --format "{{.ID}} {{.Tag}}" | tail -n +4 | awk '{print $1}' | xargs -r $DOCKER_CMD rmi 2>/dev/null || true
            
            # Clean up transferred tar file
            rm -f /tmp/${{ env.DOCKER_IMAGE }}-${{ env.DOCKER_TAG }}.tar.gz
            
            # Create env file for container
            echo "âš™ï¸ Creating environment file..."
            cat > /tmp/${{ env.APP_NAME }}.env <<EOF
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            MODEL_NAME=anthropic.claude-3-5-sonnet-20241022-v2:0
            TEMPERATURE=0.7
            MAX_TOKENS=4096
            TIMEOUT_SECONDS=60
            ENVIRONMENT=production
            LOG_LEVEL=INFO
            PORT=8080
            HOST=0.0.0.0
            EOF
            
            # Run new container
            echo "ðŸš€ Starting new container..."
            $DOCKER_CMD run -d \
              --name ${{ env.APP_NAME }} \
              --restart always \
              -p 8080:8080 \
              --env-file /tmp/${{ env.APP_NAME }}.env \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            
            # Clean up env file
            rm /tmp/${{ env.APP_NAME }}.env
            
            # Wait for container to start
            echo "â³ Waiting for container to start..."
            sleep 10
            
            # Check container status
            if $DOCKER_CMD ps | grep -q ${{ env.APP_NAME }}; then
              echo "âœ… Container is running!"
              echo ""
              echo "Container details:"
              $DOCKER_CMD ps --filter "name=${{ env.APP_NAME }}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              echo ""
              echo "Recent logs:"
              $DOCKER_CMD logs --tail 20 ${{ env.APP_NAME }}
            else
              echo "âŒ Container failed to start"
              echo "Container logs:"
              $DOCKER_CMD logs ${{ env.APP_NAME }}
              exit 1
            fi
      
      - name: Health Check
        run: |
          sleep 5
          response=$(curl -f http://${{ secrets.EC2_HOST }}:8080/health || echo "failed")
          if [ "$response" != "failed" ]; then
            echo "âœ… Health check passed!"
            echo "Response: $response"
          else
            echo "âŒ Health check failed!"
            exit 1
          fi
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **EC2 Host**: ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access Points" >> $GITHUB_STEP_SUMMARY
          echo "- Health: http://${{ secrets.EC2_HOST }}:8080/health" >> $GITHUB_STEP_SUMMARY
          echo "- API Docs: http://${{ secrets.EC2_HOST }}:8080/docs" >> $GITHUB_STEP_SUMMARY
          echo "- Query: POST http://${{ secrets.EC2_HOST }}:8080/query" >> $GITHUB_STEP_SUMMARY